<link rel="import" href="/components/polymer/polymer.html">
<link rel="import" href="../api-model-create/api-model-create.html">
<link rel="import" href="../app-session/app-session.html">
<dom-module id="api-image-upload">
  <template>

    <app-session id="session"></app-session>

    <api-model-create id="create"
      path="{{path}}" path-params="{{pathParams}}" data="{{data}}"
      model="{{image}}" on-response="on_response">
    </api-model-create>

    <input id="input" type="file" on-change="on_file">

  </template>
</dom-module>
<script>
  Polymer({

    is: 'api-image-upload',

    properties: {
      data: {
        type: Object,
        value: function () { return {}; }
      },
      path: {
        type: String
      },
      pathParams: {
        type: Object
      },
      upload_response: {
        type: Object,
        notify: true
      },
      image: {
        type: Object,
        notify: true
      }
    },

    on_file: function (event) {
      var file = this.$.input.files[0];
      var data = {};
      data.filename = file.name;
      data.filetype = file.type;
      data.container = 'standard';
      this.data = data;
      this.file = file;
      this.async(function () {
        this.$.create.send();
      })
    },

    on_response: function (event) {
      event.stopPropagation();
      var formData = new FormData();
      formData.append('file', this.file);
      var access_token = this.$.session.get('access_token');
      var xhr = new XMLHttpRequest();
      xhr.open('POST', this.image.signed_url);
      xhr.setRequestHeader('Authorization', access_token);
      xhr.send(formData);
    },

    on_upload_response: function (event) {
      this.upload_response = this.upload_response;
      this.fire('response', this.upload_response);
    }

  });
</script>