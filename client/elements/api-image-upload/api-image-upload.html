<link rel="import" href="/components/polymer/polymer.html">
<link rel="import" href="../api-model-create/api-model-create.html">
<link rel="import" href="../app-session/app-session.html">
<dom-module id="api-image-upload">
  <template>

    <app-session id="session"></app-session>

    <api-model-create id="create" collection="Images" data="{{params}}"
      response="{{image}}" on-response="on_response">
    </api-model-create>

    <input id="input" type="file" on-change="on_file">

  </template>
</dom-module>
<script>
  Polymer({

    is: 'api-image-upload',

    properties: {
      params: {
        type: Object
      },
      upload_response: {
        type: Object,
        notify: true
      },
      image: {
        type: Object,
        notify: true
      }
    },

    on_file: function (event) {
      this.file = this.$.input.files[0];
      this.params.filename = this.file.name;
      this.params.filetype = this.file.type;
      this.params.container = this.params.container || 'no-container'; // TO-DO: to be done serverside
      this.body = JSON.stringify(this.params);
      this.$.create.send();
    },

    on_response: function (event) {
      var formData = new FormData();
      formData.append('file', this.file);

      var xhr = new XMLHttpRequest();
      xhr.open('POST', this.image.signed_url);
      xhr.setRequestHeader('Authorization', this.$.session.get('access_token'));
      xhr.send(formData);
    },

    on_upload_response: function (event) {
      this.upload_response = this.upload_response;
      this.fire('response', this.upload_response);
    }

  });
</script>
